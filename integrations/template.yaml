---
template:
  - binary_sensor:
      - name: Washing machine
        icon: mdi:washing-machine
        delay_on: "00:03:00"
        delay_off: "00:03:00"
        state: >
          {{ states('sensor.plug_2_power') | float > 4 }}
      - name: Dryer
        icon: mdi:tumble-dryer
        delay_on: "00:03:00"
        delay_off: "00:03:00"
        state: >
          {{ states('sensor.plug_1_current') | float > 0.3 }}
  - sensor:
      - unique_id: sidebar
        state: template
        attributes:
          time: >
            {% set hours = now().strftime('%H') %}
            {% set minutes = now().strftime('%M') %}
            <span class="time">
              {{ hours }}<span class="time-colon">:</span>{{ minutes }}
            </span>
          date: >
            <font color='#6a7377'><b>
              {{ now().strftime('%A') }}<br>
              {{ now().strftime('%d %b') }}
            </b></font>
          greet: >
            <b>
            {% set time = now().hour %}
            {% if time <= 1 %} Good night 😑
            {% elif time <= 3 %} God night 😪
            {% elif time <= 5 %} God night 😴
            {% elif time <= 7 %} Good morning 🥱
            {% elif time <= 9 %} Good morning {{'\U00002615'}}
            {% elif time <= 12 %} Good afternoon 😄 
            {% elif time <= 15 %} Good afternoon 😎
            {% elif time <= 17 %} Good afternoon 👋🏻
            {% elif time <= 19 %} Good evening 😬
            {% elif time <= 22 %} Good evening 😌
            {% elif time <= 23 %} Good evening 🥱
            {% else %} Good evening 😪
            {% endif %}
            </b>
          active: >
            <b>
            {% set lights = [
              states.light.living_room_1,
              states.light.living_room_2,
              states.light.living_room_3,
              states.light.kitchen,
              states.light.dinning_room,
              states.light.hallway,
              states.light.third_floor,
              states.light.bedroom,
              states.light.closets
            ] %}

            {% set devices = [
              states.fan.bedroom,
              states.switch.living_room_air_freshener,
              states.switch.entrance_air_freshener
            ] %}

            {% set lights_on = lights | selectattr('state','eq','on') | list %}
            {% set lights_name = lights | selectattr('state','eq','on') | map(attribute='name') | join(', ') | lower %}

            {% set devices_on = devices | selectattr('state','search','(on|cool|fan_only|playing)') | list %}
            {% set devices_name = devices_on | map(attribute='name') | join(', ') | lower %}

            {% if (lights_on | length == 0) and (devices_on | length > 0) %}
              {{ devices_name | regex_replace(',([^,]*)$',' and\\1') }} is on

            {% elif (lights_on | length == 1) and (devices_on | length == 1) %}
              {{ lights_name }} and the {{devices_name }} is on

            {% elif (lights_on | length == 1) and (devices_on | length > 1) %}
              {{ lights_name }}, {{ devices_name | regex_replace(',([^,]*)$',' and\\1') }} is on

            {% elif (lights_on | length > 1) and (devices_on | length == 1) %}
              {{ lights_on | length }} lights and the {{ devices_name }} are on

            {% elif (lights_on | length > 1) and (devices_on | length > 1) %}
              {{ lights_on | length }} lights, {{ devices_name | regex_replace(',([^,]*)$',' and\\1') }} are on

            {% elif (lights_on | length == 1) and (devices_on | length == 0) %}
              {{ lights_name }} are on

            {% elif (lights_on | length > 1) and (devices_on | length == 0) %}
              {{ lights_on | length }} lights are on

            {% else %}
              <font color='#6a7377'>Everything is turned off</font>
            {% endif %}
            </b>
          weather: >
            {% set feels_like = states('sensor.buienradar_temperature_feels_like') | round %}
            {% set condition = states('sensor.buienradar_condition') | lower %}
            {% set full_condition = states('sensor.buienradar_full_condition') | lower %}
            {% set precipitation_probability = states('sensor.openweathermap_forecast_precipitation_probability') | int %}
            {% set season = states('sensor.season') %}

            {% set emoji %}
            {% if condition == 'clear' %}🌞
            {% elif condition == 'partly cloudy' %}🌤️
            {% elif condition == 'cloudy' %}☁️
            {% elif condition == 'rain' %}☔️
            {% elif condition == 'thunderstorm' %}🌩️
            {% elif condition == 'snow' %}❄️☃️
            {% else %}🏡
            {% endif %}
            {% endset %}

            It feels like {{ feels_like }}°, {{ full_condition }} {{ emoji }}<br>
            With {{ precipitation_probability }}% chance of precipitation.

            {% if condition == 'rain' %}
            Don't forget your umbrella! ☂️
            {% elif condition == 'thunderstorm' %}
            Stay safe and take necessary precautions during the thunderstorm. ⚡️
            {% elif precipitation_probability >= 50 %}
            You might want to consider bringing an umbrella, just in case. ☔️
            {% else %}
            No significant precipitation expected. Enjoy your day! 😊
            {% endif %}

            {% if season == 'spring' %}
            It's a lovely spring day! 🌸🌼
            {% elif season == 'summer' %}
            Enjoy the summer vibes! 🌞🌴
            {% elif season == 'autumn' %}
            Embrace the beauty of autumn! 🍂🍁
            {% elif season == 'winter' %}
            Keep warm during the winter chill! ❄️⛄️
            {% else %}
            Have a great day! 😄
            {% endif %}
