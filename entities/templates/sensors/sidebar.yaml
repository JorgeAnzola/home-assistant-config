---
unique_id: sidebar
state: template
attributes:
  time: >
    {% set hours = now().strftime('%H') %}
    {% set minutes = now().strftime('%M') %}
    <span class="time" style="font-size: 5.2vw;font-weight: 100;line-height: 4.3vw;letter-spacing: 0.11vw;margin-left: -0.3vw;color: rgba(255, 255, 255, 0.8);">
      {{ hours }}<span class="time-colon">:</span>{{ minutes }}
    </span>
  date: >
    <b style="font-weight: 700;color: rgba(255, 255, 255, 0.8);">
      {{ now().strftime('%A') }}, {{ now().strftime('%d %b') }}
      </b>
  greet: >
    <b style="font-weight: 700;color: rgba(255, 255, 255, 0.8);">
    {% set time = now().hour %}
    {% if time <= 1 %} Good night 😪
    {% elif time <= 3 %} God night 😴
    {% elif time <= 5 %} God night 😑
    {% elif time <= 7 %} Good morning 🥱
    {% elif time <= 9 %} Good morning {{'\U00002615'}}
    {% elif time <= 12 %} Good morning 😄
    {% elif time <= 15 %} Good afternoon 😎
    {% elif time <= 17 %} Good afternoon 👋🏻
    {% elif time <= 19 %} Good evening 😬
    {% elif time <= 22 %} Good evening 😌
    {% elif time <= 23 %} Good evening 🥱
    {% else %} Good evening 😪
    {% endif %}
    </b>

  weather: >
    {% set feels_like = states('sensor.buienradar_temperature_feels_like') | round %}
    {% set condition = states('sensor.buienradar_condition') | lower %}
    {% set full_condition = states('sensor.buienradar_full_condition') | lower %}
    {% set precipitation_probability = states('sensor.openweathermap_forecast_precipitation_probability') | int %}

    {% set emoji %}
    {% if condition == 'clear' %}🌞
    {% elif condition == 'partly cloudy' %}🌤️
    {% elif condition == 'cloudy' %}☁️
    {% elif condition == 'rain' %}☔️
    {% elif condition == 'thunderstorm' %}🌩️
    {% elif condition == 'snow' %}❄️☃️
    {% else %}🏡
    {% endif %}
    {% endset %}

    It feels like {{ feels_like }}°, {{ full_condition }} {{ emoji }}<br/><br/>
    With {{ precipitation_probability }}% chance of precipitation.<br/><br/>

    {% if condition == 'rain' %}
    Don't forget your umbrella! ☂️
    {% elif condition == 'thunderstorm' %}
    Stay safe and take necessary precautions during the thunderstorm. ⚡️
    {% elif precipitation_probability >= 50 %}
    You might want to consider bringing an umbrella, just in case. ☔️
    {% else %}
    No significant precipitation expected.
    {% endif %}
    <br/>
  calendar: >
    {% set calendars = [
      'calendar.birthdays',
      'calendar.bruno',
      'calendar.lake_house',
      'calendar.jorge_anzola_gmail_com'
    ] %}

    {% set tomorrowStartDateTime = (as_timestamp(now()) + (86400)) | timestamp_custom("%Y-%m-%d 00:00:00",true) %}
    {% set tomorrowStartTimestamp = strptime(tomorrowStartDateTime, "%Y-%m-%d %H:%M:%S").timestamp() | int %}
    {% set tomorrowEndDateTime = (as_timestamp(now()) + (86400)) | timestamp_custom("%Y-%m-%d 23:59:59",true) %}
    {% set tomorrowEndTimestamp = strptime(tomorrowEndDateTime, "%Y-%m-%d %H:%M:%S").timestamp() | int%}

    {% set now = now().timestamp() | int %}


    {% set data = namespace(events=[],tomorrowEvents=[]) %}

    {% for calendar in calendars %}
        {% set startTime = state_attr(calendar, 'start_time') | as_timestamp | int %}
        {% set endTime = state_attr(calendar, 'end_time') | as_timestamp | int %}
        {% if startTime <= now and now < endTime %}
            {% set message = state_attr(calendar, 'message') %}
            {% if 'birthdays' in calendar %}
                {% set event = {
                    'name':'<strong style="color:white">' + message + "'s birthday</strong>",
                    'calendar': calendar.split('.')[-1]
                } %}
            {% elif 'bruno' in calendar %}
                {% set event = {
                    'name': '<strong style="color:white">Brunos ' + message + '</strong>',
                    'calendar': calendar.split('.')[-1]
                } %}
            {% else %}
                {% set event = {
                    'name': '<strong style="color:white">' + message + '</strong>',
                    'calendar': calendar.split('.')[-1]
                } %}
            {% endif %}
            {% set data.events = data.events + [event] %}
        {% endif %}
        
        {% if startTime >= tomorrowStartTimestamp and endTime < tomorrowEndTimestamp %}
            {% set message = state_attr(calendar, 'message') %}
            {% if 'birthdays' in calendar %}
                {% set tomorrowEvent = {
                    'name':'<strong style="color:white">' + message + "'s birthday</strong>",
                    'calendar': calendar.split('.')[-1]
                } %}
            {% elif 'bruno' in calendar %}
                {% set tomorrowEvent = {
                    'name': '<strong style="color:white">Brunos ' + message + '</strong>',
                    'calendar': calendar.split('.')[-1]
                } %}
            {% else %}
                {% set tomorrowEvent = {
                    'name': '<strong style="color:white">' + message + '</strong>',
                    'calendar': calendar.split('.')[-1]
                } %}
            {% endif %}
            {% set data.tomorrowEvents = data.tomorrowEvents + [tomorrowEvent] %}
        {% endif %}
    {% endfor %}

    {% set eventCount = data.events | length %}

    {% if eventCount == 1 %}
        🗓️ For today: {{ data.events[0]['name'] }} 
    {% elif eventCount == 2 %}
        🗓️ For today:  {{ data.events[0]['name'] }} and {{ data.events[1]['name'] }}
    {% elif eventCount > 2 %}
        {% set remainingCount = eventCount - 2 %}
        🗓️ For today: {{ data.events[0]['name'] }}, {{ data.events[1]['name'] }} and {{ remainingCount }} others
    {% endif %}

    {% set tomorrowEventCount = data.tomorrowEvents | length %}

    {% if tomorrowEventCount == 1 %}
        🗓️ For tomorrow: {{ data.tomorrowEvents[0]['name'] }} 
    {% elif tomorrowEventCount == 2 %}
        🗓️ For tomorrow:  {{ data.tomorrowEvents[0]['name'] }} and {{ data.tomorrowEvents[1]['name'] }}
    {% elif tomorrowEventCount > 2 %}
        {% set remainingCount = tomorrowEventCount - 2 %}
        🗓️ For tomorrow: {{ data.tomorrowEvents[0]['name'] }}, {{ data.tomorrowEvents[1]['name'] }} and {{ remainingCount }} others
    {% endif %}
